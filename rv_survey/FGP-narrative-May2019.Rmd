---
title: "Extract to cerat cSV used to feed FGP/OGSL/ETC"
author: "Pablo Vergara"
date: "May 17 2019"
output:
  html_document: default
  pdf_document: default
  word_document: default
---
This document is the narrative of how an Excel file called "sGSL-September-RV-FGP.csv" was generated. 

The DFO Gulf Region September RV survey follows a stratified random sampling design and covers Division 4T of the Northwest Atlantic Fisheries Organisation (NAFO).


```{r setup, fig.height=6, fig.width=6}
`%nin%` = Negate(`%in%`) ## a useful operator
suppressPackageStartupMessages(library(gulf))
```

## SETS
Using the function "read.card" from the DFO Gulf Region's R package "gulf", read in the set cards and exclude hydrographic stations and null sets, so as to keep only representative tows in strata 415 to 439. Strata 401, 402 and 403 are excluded because they were not sampled prior to 1985.

```{r sets}
yrs <- 2018 # only producing 2018 for the moment, will produce others years once we are sure data is in proper format
x <- read.card(card.type="set", year=yrs)
```

Add a few useful columns to the data frame containing the set card information (including depth and swept area as requested).
```{r sets2}
## add useful columns
x$unique.id <- paste(x$year, x$cruise.number, x$vessel.code, x$set.number, sep="-")
x$experiment.str <- experiment.str(x$experiment)
x[x$vessel.code=="T" & x$year==2003,"vessel.code"] <- "TE" ## CCGS Templeman used in 2003
x$vessel.str <- vessel.str(x$vessel.code)
x$gear.str <- gear.str(x$gear)
x$longitude <- longitude(x)
x$latitude <- latitude(x)

ox <- order(x$year, x$month, x$day, x$start.hour)
x <- x[ox,] # reorder chronologically 

```

Catch cards contain the total catch information for the species of interest. Here they are adjusted for distance towed, estimated diurnal effects and estimated vessel-gear effects.  
```{r catch2}
### Catch card for all years requesteed (1971 - 2018)
y <- read.card(card.type="catch", year = yrs)
```

## CATCH
```{r adjust}
y <- adjust(y, x)
y$unique.id <- paste(y$year, y$cruise.number, y$vessel.code, y$set.number, sep="-")
y$english.name <- species.str(y$species, "english")
y$latin.name <- species.str(y$species, "latin")
y$french.name <- species.str(y$species, "french")

z <- merge(y,x, all.x = TRUE, by = "unique.id", names = c("longitude","latitude", "gear.str"))

##  CSV
## write catch cards to file
fn2 <- "sGSL-September-RV-FGP.csv"
fp  <- "e:/work/GC code/gulf/"
csv.fn2 <- file.path(fp,fn2)

ooz <- order(z$year, z$month, z$day, z$start.hour, z$start.minute, z$species)

#columns to keep
fvars2 <- c("year","month","day","start.hour","start.minute","latitude","longitude","gear.str","species","french.name","english.name","latin.name","weight.caught","number.caught")
zz=  z[ooz,fvars2]
write.csv(zz, file=csv.fn2, row.names=FALSE)
```


