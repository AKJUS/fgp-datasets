---
title: "Creation of Atlantic Cod ageing datasets for OpenData"
author: "Daniel Ricard"
date: "January 9, 2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(gulf)
library(ggplot2)
```

## Atlantic Cod
Atlantic Cod otoliths are collected on the annual September RV survey and during scientific sampling of commercial fisheries.

The goal here is to summarise the ageing materials that we have, and provide a dataset of the otoliths that we have at the Gulf Fisheries Centre.


```{r cod}
## RV data
y <- read.card(species=10, card.type="bio")



## commercial data
## what years are available for commercial ages?
## com.files <- list.files(path="//DFNBE1CwpFSP002/Hd2/commercial/age", pattern="codage")
y.c <- read.card(year=1982, sampling="commercial", species=10, card.type="age") ## this loads all pre-1982 commercial ages
for(yy in c(1983:2002,2004:2018)){ ## loop over years
t.c <- read.card(year=yy, sampling="commercial", species=10, card.type="age")
y.c <- rbind(y.c,t.c)
}
l.4tvn <- which(substring(y.c$nafo.division,1,2)=="4T" | substring(y.c$nafo.division,1,3)=="4VN") ## keep only otoliths collected in NAFO 4TVN

rv.df <- aggregate(fish.number~year+month, data=y[which(y$age.material==1),], length)
rv.df$source <- "RV"
names(rv.df)[3] <- "number.otoliths_nombre.otolithes"

comm.df <- aggregate(otolith.number~year+month, data=y.c[l.4tvn,], length)
names(comm.df)[3] <- "number.otoliths_nombre.otolithes"
comm.df$source <- "Commercial"


cod.out.df <- rbind(rv.df, comm.df)
cod.out.df$latin.name_nom.latin <- "Gadus morhua"
cod.out.df$english.name_nom.anglais <- "Atlantic Cod"
cod.out.df$french.name_nom.français <- "Morue franche"


vars <- c("source", "latin.name_nom.latin", "english.name_nom.anglais", "french.name_nom.français", "year","month","number.otoliths_nombre.otolithes")
o1 <- order(cod.out.df$source, cod.out.df$year, cod.out.df$month)

cod.out.fn <- "NAFO-4T-Atlantic-Cod-ages.csv"
write.csv(cod.out.df[o1,vars], file=cod.out.fn, row.names = FALSE)
  
## and a so-called data dictionary to explain the different columns in the CSV file
vars.bilingual <- c("source", "latin.name_nom.latin", "english.name_nom.anglais", "french.name_nom.français", "year_année","month_mois","number.otoliths_nombre.otolithes")

data.dic <- data.frame(
  name_nom = vars.bilingual
  )
data.dic$description_fr <- c("Source de otolithes, peut soit provenir du relevé par navire de recherche (Research Vessel (RV)) ou d'échantillonnage des pêches commerciales (Commercial)", "Nom latin de l'espèce", "Nom anglais de l'espèce", "Nom français de l'espèce", "Année d'échantillonnage des otolithes", "Mois d'échantillonnage des otolithes", "Nombre d'otolithes dans la collection")

data.dic$description_en <- c("Source of otoliths, can be either from the Research Vessel (RV) survey or from commercial sampling (Commercial)", "Latin name of the species", "English name of the species", "French name of the species", "Year when otoliths were collected", "Month when otolith were collected", "Number of otoliths in collection")

data.dic.fn <- "data-dictionary.csv"
write.csv(data.dic, file=data.dic.fn, row.names = FALSE)
```

The Web Service to be associated with this dataset will just be a polygon of NAFO division 4T.



